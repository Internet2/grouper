<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>How to Customise the Grouper UI</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
</head>

<body>
<h1>How to Customise the Grouper User Interface (UI)</h1>

<div class="toc">
<ul>
  <li><a href="#Introducti">Introduction</a></li>
  <li><a href="#changes">CSS changes</a></li>
  <li><a href="#Changing">Changing the Internet2 logo</a></li>
  <li><a href="#Changing1">Changing the default text</a></li>
  <li><a href="#Using">Using custom templates instead of the standard
    templates</a></li>
  <li><a href="#Defining">Defining custom dynamic templates</a></li>
  <li><a href="#Modifying">Modifying existing Struts actions, adding new
    actions and making new Tiles definitions available</a></li>
  <li><a href="#Customisin">Customising authentication</a></li>
  <li><a href="#Customisin1">Customising the Root node of the Grouper
    repository</a></li>
  <li><a href="#Creating">Creating an <em>InitialStems</em> view</a></li>
  <li><a href="#Customisin2">Customising the build process</a></li>
  <li><a href="#Customisin3">Customising web.xml</a></li>
    <li><a href="#applicatio">Running the standard UI at the same time as the 
      custom UI</a></li>
  <li><a href="#Determinin">Determining how a Grouper UI page was
    constructed</a></li>
	<li><a href="#future">Future enhancements</a></li>
	<li><a href="#feedback">Providing feedback and getting help</a></li>
</ul>
</div>

<h2 id="Introducti">Introduction</h2>

<p>This document is aimed at web application developers. It describes how to make 
  changes to the Grouper UI and is best understood with reference to the <a href="ui-architecture.html">Grouper 
  UI architecture</a> (which contains links to underlying concepts and technologies). 
  The section <a href="#Determinin">Determining how a Grouper UI page was constructed</a> 
  explains how to display on screen information which can help determine what 
  you need to change in order to modify a Grouper UI page. <a href="actions.html">Struts 
  Actions in the Grouper UI</a> gives an overview of which Strus actions relate 
  to which functional aeas.</p>
<p>The document focuses on the specific customisations which can be built into 
  the QuickStart demo (see the <a
href="../README.html">QuickStart README</a>), and will refer to differences between 
  the standard and custom screen shots in <a
href="grouper-uis.html">grouper-uis.html</a>. You may want to open this link in 
  a separate window / tab for reference.</p>
<p>The UI has been designed so that the source code for the standard UI need not 
  be changed in order to effect customisations. This is intended to make it easier 
  to upgrade changes to the standard UI without compromising customisations you 
  have made. </p>
<p>The structure and contents of <strong><font face="Courier New, Courier, mono">grouper-qs/custom-grouper-ui 
  </font></strong>should be used as the starting point for your own custom Grouper 
  UI.</p>
<h2 id="changes">CSS changes</h2>

<p>Grouper has its own CSS stylesheets, but provides a mechanism for a site-specific 
  stylesheet to be loaded after the Grouper stylesheets. This allows sites to 
  override / extend existing styles and to add new styles. Such changes can alter 
  the position of screen elements, fonts, colours etc.</p>

<p>The custom stylesheet was configured in <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/resources/custom/media.properties</strong></font>:</p>

<p><font
face="Courier New, Courier, mono"><strong>css.additional=custom/custom.css</strong></font></p>

<p>The actual stylesheet is found at <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/webapp/custom</strong></font><strong>/<font
face="Courier New, Courier, mono">custom.css</font></strong>.</p>

<p>Differences in the standard and custom UIs which are due to CSS are listed 
  below:</p>

<table width="75%" border="1">
  <tbody>
    <tr bgcolor="#CCCCCC">
      <td><strong>Feature</strong></td>
      <td><strong>Standard UI</strong></td>
      <td><strong>Custom UI</strong></td>
    </tr>
    <tr>
      <td>Menu</td>
      <td>Positioned vertically on left.</td>
      <td>Positioned horizontally below logos. Various colour changes</td>
    </tr>
    <tr>
      <td>Content area</td>
      <td>To right of menu</td>
      <td>Aligned left and full width</td>
    </tr>
    <tr>
      <td>'Members'</td>
      <td>Blue text on pale background</td>
      <td>White text on grey background</td>
    </tr>
  </tbody>
</table>

<p>Many more CSS classes are applied to elements in the HTML source than are specified 
  in the Grouper stylesheets so a high degree of CSS customisation is possible.</p>
<p>It is possible to turn off the style sheets. This may be useful for testing 
  the accessibility of the Grouper UI and any customisations you make (see the 
  <em>Remove CSS stylesheet references?</em> form field in <a href="#Determinin">Determining 
  how a Grouper UI page was constructed</a>).</p>

<h2 id="Changing">Changing the Internet2 logo</h2>

<p>In <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/resources/custom/media.properties</strong></font>, 
  the following property was set:</p>

<p><font
face="Courier New, Courier, mono"><strong>image.organisation-logo=custom/images/banner.logo.gif</strong></font></p>

<h2 id="Changing1">Changing the default text</h2>

<p>In the standard UI all navigational text and instructions are derived from 
  a Java ResourceBundle based on <font
face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui/resources/grouper/nav.properties</strong></font>.</p>

<p>In the custom UI, values for keys set in <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/resources/custom/nav.properties</strong></font> 
  will override the standard UI values. In the UI example screen shots, the custom 
  UI includes <em>UoB</em> in menu items and changes <em>Help</em> to <em>Assistance</em>.</p>

<p>Through the use of Java ResourceBundles, the Grouper UI supports Internationalization. 
  The default locale for the standard UI is set in <font
face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui/resources/init.properties</strong></font>:</p>

<p><font face="Courier New, Courier, mono">default.locale=en_US</font></p>

<p>In <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/resources/init.properties</strong></font><strong>, 
  <font face="Courier New, Courier, mono">default.locale=en_GB</font></strong>, 
  however, there is no <em>nav_en_GB.properties</em> file so there are no differences 
  due to locale in the standard and custom UIs.</p>

<p>Currently, there is no where in the UI to select a different locale from
the default, however, if a <em>lang</em> parameter is passed as part of the
URL which invokes login, the value will be used as the locale for the current
session.</p>

<p>See <a href="#Determinin">Determining how a Grouper UI page was constructed</a> 
  for details of how to display which key / value pairs were used in an actual 
  page in the UI.</p>
<p>If you create your own templates you are not under any obligation to use ResourceBundles 
  instead of directly entering text in templates, however, if you wish to contribute 
  code back to Grouper, such a contribution would be more useful if it used ResourceBundles.</p>

<h2 id="Using">Using custom templates instead of the standard templates</h2>

<p>The Grouper UI uses Strut's Tiles to define core page components. In the standard 
  UI these are defined in <font
face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui/webapp/WEB-INF/tiles-def.xml</strong></font>. 
  In the custom UI some definitions are modified and another added in the file 
  <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/webapp/WEB-INF/tiles-def-custom.xml</strong></font>. 
  New definitions for <em>headerDef</em> and<em> footerDef</em> allow site specific 
  branding. <em>groupStuffDef</em> defines a template which is included in the 
  Group Summary page of the UI.</p>

<p><em>EasyLoginFormDef</em> defines a new page (see <a href="#Customisin">Customising 
  authentication</a>).</p>
<h2 id="Defining">Defining custom dynamic templates</h2>

<p>Grouper recognises some core entities such as Groups, Stems, Subjects and Collections. 
  The Grouper UI dynamically chooses the appropriate template for an entity at 
  runtime based on its type and the UI context. The default templates for an entity 
  and view are defined in <font
face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui/resources/grouper/media.properties</strong>. 
  </font>When a specific entity-view key is not found, a default is used. Key-value 
  pairs can be overridden, or more specific keys added to <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/resources/grouper/media.properties</strong>.</font>The 
  algorithms used to choose appropriate keys are described in the Javadoc for 
  <font
face="Courier New, Courier, mono"><a href="api/edu/internet2/middleware/grouper/ui/DefaultTemplateResolverImpl.html">DefaultTemplateResolverImpl</a></font>. 
  This class can be extended to add support for other entity types, or a completely 
  new implementation plugged in (see Javadoc for the <a href="api/edu/internet2/middleware/grouper/ui/TemplateResolver.html"><em>TemplateResolver</em></a> 
  interface.</p>

<p>In the standard UI the default template for a subject is defined:</p>

<p><font
face="Courier New, Courier, mono"><strong>subject.view.default=/WEB-INF/jsp/subjectView.jsp</strong></font></p>

<p>In the custom UI:</p>

<p><font
face="Courier New, Courier, mono"><strong>personQS.view.default=/WEB-INF/jsp/custom/customPersonSubjectView.jsp</strong></font></p>

<p>defines a specific template for subjects whose source has an ID of personQS. 
  In the UI examples the name Keith Benson is followed by (kebe) in the custom 
  UI due to the use of <font
face="Courier New, Courier, mono"><strong>/WEB-INF/jsp/custom/customPersonSubjectView.jsp</strong></font> 
  as a template. Subjects and groups may have any number of site specific attributes, 
  so dynamic templates allow sites to create templates which have access to these 
  custom attributes.</p>

<p>See <a href="#Determinin">Determining how a Grouper UI page was constructed</a> 
  for how to determine which template was chosen for an entity-view on a page 
  in the UI.</p>

<h2 id="Modifying">Modifying existing Struts actions, adding new actions and
making new Tiles definitions available</h2>

<p>The Grouper UI is based on Struts and the standard Struts configuration is 
  through <font
face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui/webapp/WEB-INF/struts-config.xml</strong></font>. 
  Existing actions can be replaced and new ones added to <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/webapp/WEB-INF/struts-config-custom.xml</strong></font>.</p>
<p>See <a href="actions.html">Struts Actions in the Grouper UI</a> for an explanation 
  of how the standard Grouper ui actions interact.</p>

<p>In the custom UI the action <em>/callLogin</em> is redefined such that it forwards 
  to <em>/easyLogin</em> - a new action.</p>
<p>More information on how to change the behaviour of the Grouper Struts actions 
  is available in the appropriate <a href="api/edu/internet2/middleware/grouper/ui/actions/package-summary.html">javadoc 
  package description</a>.</p>

<p>Even if you don't need to change / add any actions, in order to make custom 
  templates available (see <a href="#Using">Using custom templates instead of 
  the standard templates</a>) a Tiles plugin must be configured:</p>

<pre><font face="Courier New, Courier, mono">&lt;plug-in className="org.apache.struts.tiles.TilesPlugin"&gt;
 &lt;set-property property="moduleAware" value="true"/&gt;
 &lt;set-property property="definitions-debug" value="0"/&gt;
 &lt;set-property property="definitions-parser-details" value="0"/&gt;
 &lt;set-property property="definitions-parser-validate" value="false"/&gt;
 &lt;set-property property="definitions-config" value="/WEB-INF/tiles-def.xml,<strong>/WEB-INF/tiles-def-custom.xml</strong>"/&gt;
&lt;/plug-in&gt;</font></pre>

<p>Note that the order of files in the definitions-config property is
important as the last Tile definition with a particular name loaded is
used.</p>

<h2 id="Customisin">Customising authentication</h2>

<p>The standard UI uses basic HTTP authentication configuerd through Tomcat and 
  the web application web.xml file. A Filter <em>LoginCheckFilter</em> checks 
  if you are logged in before allowing access to the application. It checks the<strong><font face="Courier New, Courier, mono"> 
  javax.servlet.http.HttpServletRequest.getRemoteUser()</font></strong>. If not 
  set the user is redirected to the splash page, otherwise, access is granted, 
  and if necessary, the user session initialised.</p>

<p>In the custom UI, when a user clicks the <em>Login</em> link on the splash 
  page, the <em>/callLogin</em> action is requested. This forwards the user to 
  the<em> /easyLogin </em>action which displays the template named <em>EasyLoginFormDef, 
  </em>which is a simple form allowing a username to be entered. The custom UI 
  also defines a Filter <em>EasyLoginFilter</em> which is called prior to <em>LoginCheckFilter</em>. 
  If it <em>sees</em> a request parameter called username, it attempts to load 
  a Subject (through <em>Subject.getSubjectByIdentifier</em>). If successful, 
  it stores the username in the HttpSession and calls the next Filter in sequence 
  with a modified <em>HttpServletRequest</em>, which responds to getRemoteUser() 
  by returning the stored username.</p>

<p>This section shows how new authentication schemes can be introduced. A more 
  serious scheme which allows Yale CAS authentication has been <a
href="../contrib/yale-cas-auth/README.html">contributed</a> to the Grouper UI 
  distribution.</p>

<p>In order to configure new Filters it is necessary to modify the web application 
  web.xml file. How to do this is described in <a href="#Customisin3">Customising 
  web.xml</a>.</p>

<p>NB. The standard UI does not have a logout link because it is not possible 
  to safely logout of basic HTTP authentication. Other authentication schemes 
  will generally work by setting an HttpSession attribute - which is cleared when 
  an HttpSession is invalidated, so a logout link is provided.</p>

<h2 id="Customisin1">Customising the Root node of the Grouper repository</h2>

<p>The Grouper API defines a notional root stem <em>Grouper.NS_ROOT</em>. In the 
  standard UI the <strong>Current location</strong> begins with <em>Root</em> 
  whereas in the custom UI it starts with <em>QS University of Bristol.</em> Both 
  screen shots are views of the same Grouper repository. Three scenarios are possible</p>
<ol>
  <li>Root is visible, and browsing starts at Root,</li>
  <li>Root is visible but browsing starts at a defined stem e.g. <em>QS
    University of Bristol.</em></li>
  <li>Root is not visible and browsing starts at a defined stem e.g.<em>
    <em>QS University of Bristol.</em></em></li>
</ol>

<p>Which scenario is used depends on two different properties:</p>
<ol>
  <li><font face="Courier New, Courier, mono"><strong>default.browse.stem</strong></font> 
    from media.properties</li>
  <li><font face="Courier New, Courier, mono"><strong>stem.root.display-name</strong></font> 
    from nav.properties</li>
</ol>

<p>If <font face="Courier New, Courier, mono"><strong>default.browse.stem</strong></font> 
  is defined, the UI will default to that stem for browsing. If <font
face="Courier New, Courier, mono"><strong>stem.root.display-name</strong></font> 
  is defined as anything other than *, a root node will be displayed - with the 
  value assigned to the key.</p>

<h2 id="Creating">Creating an <em>InitialStems</em> view</h2>

<p>This feature is not implemented in either the standard or custom UIs, however, 
  it provides an alternative starting point to browsing by allowing sites to provide 
  a customised list of stems or <em>quick links</em>. The list of stems can come 
  from any part of the hierarchy and so may provide a better starting point for 
  users e.g. for GrouperSystem the default view is:</p>

<p><img src="hier.png" width="187" height="124" alt="img"></p>

<p>but for another user e.g. an art student, the following list might be more 
  appropriate:</p>
<ul>
  <li>Personal groups for &lt;name&gt;</li>
  <li>Arts faculty</li>
  <li>Student Union clubs</li>
</ul>

<p>Such a list could be generated in a site-specific way based on a username. 
  A site might also provide a means for a user to edit their list of quick links.</p>

<p>See Javadoc for <em><a href="api/edu/internet2/middleware/grouper/ui/InitialStems.html">InitialStems</a></em> 
  interface.</p>

<h2 id="Customisin2">Customising the build process</h2>

<p>The Grouper UI uses the <font
face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui/build.xml</strong></font> 
  ant script to build the web application. This script is configured through <font
face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui/build.properties</strong></font>, 
  which has a key <font
face="Courier New, Courier, mono"><strong>additional.build</strong></font>. In 
  the custom UI this is set to <font
face="Courier New, Courier, mono"><strong>${basedir}/../custom-grouper-ui/additional-build.xml</strong></font>. 
  It is the responsibility of this script, which is called by the standard script, 
  to compile any Java source files and to copy to the build area any other necessary 
  files. If you wish to incorporate any contributed code, calls to the relevant 
  build scripts should be placed here. In the <font
face="Courier New, Courier, mono"><strong>custom-grouper-ui/additional-build.xml</strong></font> 
  script, the struts-patch build script is called.</p>

<h2 id="Customisin3">Customising web.xml</h2>

<p>A web application web.xml file is a key configuration file and any site wishing 
  to customise the Grouper UI will need to modify it. The default deployment descriptor 
  is found at <font
face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui/webapp/WEB-INF/web.core.xml</strong></font>. 
  The UI provies a mechanism for merging fragments of different web.xml files 
  into a final deployment file. In your additional build script (see <a href="#Customisin2">Customising 
  the build process</a>) copy any web.xml fragments into <strong><font face="Courier New, Courier, mono">${temp.dir}</font></strong>. 
  Typically files should be prefixed with a 2 digit number e.g. 20 (90 is used 
  for web.core.ml). The merging process merges in name order of the files.</p>

<p>The custom UI includes two web.xml fragments which, when copied, are
prefixed with 00 and 95 so the former is merged with web.core.xml and the
latter is merged with the result of the first merge.</p>

<p>The first web.xml fragment is <font
face="Courier New, Courier, mono"><strong>grouper-qs/custom-grouper-ui/webapp/WEB-INF/web.custom.xml</strong> 
  </font>and it overrides the default action servlet definition to ensure that 
  it loads the Struts config customisations - which in turn load the Tiles definition 
  customisations.</p>
<pre>&lt;servlet&gt;
   &lt;servlet-name&gt;action&lt;/servlet-name&gt;
   &lt;servlet-class&gt;org.apache.struts.action.ActionServlet&lt;/servlet-class&gt;
   &lt;init-param&gt;
           &lt;param-name&gt;config&lt;/param-name&gt;
           &lt;param-value&gt;/WEB-INF/struts-config-custom.xml,/WEB-INF/struts-config.xml,/WEB-INF/struts-config-custom.xml&lt;/param-value&gt;
   &lt;/init-param&gt;
   &lt;init-param&gt;
           &lt;param-name&gt;config/i2mi&lt;/param-name&gt;
           &lt;param-value&gt;/WEB-INF/struts-config.xml&lt;/param-value&gt;
   &lt;/init-param&gt;
   &lt;load-on-startup&gt;2&lt;/load-on-startup&gt;
&lt;/servlet&gt;</pre>

<p>NB. As the order of elements in the final web.xml file is important it can 
  be difficult to get elements in the order you want. The merging process is not 
  extensively tested and it is quite likely it will not work properly for all 
  elements. It may be necessary to rework the merging process, or resort to manual 
  editing of the web.core.xml file.</p>

<p>The merge process is dependent on <font
face="Courier New, Courier, mono"><strong>web-xml-merge.xsl</strong></font> and 
  <font
face="Courier New, Courier, mono"><strong>web-xml-merge-tags.xml</strong></font> 
  found in <font face="Courier New, Courier, mono"><strong>grouper-qs/grouper-ui</strong></font>.</p>

<h2 id="applicatio">Running the standard UI at the same time as the custom UI</h2>

<p>By applying the <a href="../contrib/struts-patch/README.html">struts-patch 
  contribution</a> (see <a href="#Customisin2">Customising the build process</a>), 
  and configuring the Struts action servlet with more than one module see (<strong><font face="Courier New, Courier, mono">config/i2mi</font></strong> 
  parameter in <a href="#Customisin3">Customising web.xml</a>), it is possible 
  to have both the standard and custom UIs available at the same time.</p>

<p>After building the custom Grouper UI you appear to <em>lose</em> the standard 
  UI, however, if instead of accessing <em>/grouper</em> you access <em>/grouper/i2mi</em> 
  in your web browser you get the standard UI.</p>

<h2 id="Determinin">Determining how a Grouper UI page was constructed</h2>

<p>Since a Grouper UI page may be constructed from many templates, including
dynamic templates, and it may not be easy to determine which ResourceBundle
key was used to render text, a mechanism has been created to display
<em>debug</em> information. Go to the URl
<em>/grouper/populateDebugPrefs.do</em>. You should see a form:</p>

<p><img src="Debug-prefs.png" width="777" height="277" alt="img"></p>

<p>The form fields are explained in the table below:</p>

<table width="75%" border="1">
  <tbody>
    <tr bgcolor="#CCCCCC">
      <td><strong>Field</strong></td>
      <td><strong>Description</strong></td>
    </tr>
    <tr>
      <td>Enable debug display</td>
      <td>Determines if debug information is shown at the bottom of the page. 
        If not selected none of the other options are active</td>
    </tr>
    <tr>
      <td>Webapp root for I2mi*</td>
      <td>The complete file system path to the standard UI webapp root</td>
    </tr>
    <tr>
      <td>Webapp root for your site*</td>
      <td>The complete file system path to the custom UI webapp root</td>
    </tr>
    <tr>
      <td>Show resource keys and values at end of page</td>
      <td>If selected, any key-value pairs derived from the nav
        ResourceBundle to display screen text are listed</td>
    </tr>
    <tr>
      <td>Show resource keys in page rather than values</td>
      <td>Instead of seeing the text in the page you will see ???key???</td>
    </tr>
    <tr>
      <td>Show dynamic tiles</td>
      <td>If selected, a hierarchy of templates used to construct the page is 
        shown. If a template was loaded dynamically the <em>view</em>, <em>entity 
        type</em>, <em>chosen key</em> and<em> template name</em> are displayed</td>
    </tr>
    <tr>
      <td>Executable for JSP editor</td>
      <td><p>The complete filesystem path to a JSP editor - only use if the server 
          is your working machine! </p>

        <p>If the webapp roots above are specified, template names are links which 
          will open the template file in the specified JSP editor</p>
      </td>
    </tr>
    <tr>
      <td>Remove CSS stylesheet references?</td>
      <td>Let's you see the non stylised page - used for checking
        accessibility in absence of a screen reader.</td>
    </tr>
  </tbody>
</table>

<p> *These fields are only required if you wish to link template names to a JSP 
  editor. </p>
  <h2 id="future">Future enhancements</h2>
  The Grouper UI, in its main menu sections (such as My memberships), allows various 
views of the groups hierarchy to be browsed. Currently it would be difficult to 
add a new view associated with a menu item without adding a lot of code / duplicating 
existing logic. A future version of the UI will allow new browse modes to be configured 
and associated with an implementing Java class. 
<h2 id="feedback">Providing feedback and getting help</h2>
The Grouper UI is intended to be extensible and not to force unnecessary constraints, 
however, it is only as sites try to make their own customisations that the true 
extensibility can be tested. If while customising the Grouper UI you find yourself 
forced to modify standard Grouper UI sources (of any kind), or find that you cannot 
easily do what you want to, please feedback to, or request help via the grouper-users 
mailing list. 
</body>
</html>
