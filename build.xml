<!-- $Id: build.xml,v 1.22 2004-11-23 22:16:43 blair Exp $ -->

<project name="Grouper" default="build" basedir=".">

  <!-- set global properties for this build -->
  <property name="app.name"         value="Grouper"/>
  <property name="src"              location="java/src"/>
  <property name="build"            location="build"/>
  <property name="src-test"         location="java/tests"/>
  <property name="build-test"       location="build/test"/>
  <property name="dist"             location="dist"/>
  <property name="javadoc.source"   value="${src}"/>
  <property name="javadoc.dest"     value="${dist}/api"/>
  <property name="javadoc.packages" value="edu.internet2.middleware.grouper.*"/>
  <property name="jdbc.driver"      value="org.hsqldb.jdbcDriver"/>
  <property name="jdbc.url"         value="jdbc:hsqldb:${dist}/run/grouper"/>

  <target name="init">
    <tstamp />
    <mkdir dir="${build}" />
    <!-- only define our classpath once -->
    <path id="project.class.path">
      <pathelement path="${classpath}"/>
      <!-- for configuration files -->
      <pathelement path="${basedir}/conf"/>
      <fileset dir="java/lib">
        <include name="**/*.jar"/>
      </fileset>
      <pathelement location="${build}/"/>
      <pathelement location="${build}/test/"/>
    </path>
  </target>

  <target name="build" depends="init"
        description="compile the source " >
    <javac srcdir="${src}" destdir="${build}">
      <classpath refid="project.class.path"/>
    </javac>
    <copy file="${basedir}/conf/grouper.properties" 
          tofile="${build}/edu/internet2/middleware/grouper/grouper.properties"/>
    <copy file="${basedir}/conf/Grouper.hbm.xml"
          tofile="${build}/edu/internet2/middleware/grouper/Grouper.hbm.xml"/>
  </target>

  <target name="dist" depends="build" description="generate the distribution" >
    <mkdir dir="${dist}/lib" />
    <jar jarfile="${dist}/lib/${app.name}-${DSTAMP}.jar" basedir="${build}" />
    <copy file="${dist}/lib/${app.name}-${DSTAMP}.jar"   tofile="${dist}/lib/${app.name}.jar" />
  </target>

  <target name="jar" depends="dist" />

  <target name="clean" description="clean up" >
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
  </target>

  <target name="all" depends="dist,test,html" />

  <target name="html">
    <!-- Let's be sure we clear out old cruft first... -->
    <delete dir="${javadoc.dest}" />
    <javadoc sourcepath="${javadoc.source}" 
      destdir="${javadoc.dest}" 
      packagenames="${javadoc.packages}" 
      classpathref="project.class.path" 
      private="false"   
      author="true"/>
  </target>

  <target name="test" depends="test-run">
  </target>

  <target name="test-build" depends="build">
    <mkdir dir="${build-test}" />
    <javac srcdir="${src-test}" destdir="${build-test}">
      <classpath refid="project.class.path" />
      <include name="**/*.java" />
    </javac>
  </target>

  <target name="test-run" depends="test-build">
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestInstantiate" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestConfigAndSchema" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestSubjects" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestSessions" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestMembers" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestNamespaces" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestGroups" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestGroupLists" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestNamingPrivs" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestAccessPrivs" />
      <classpath refid="project.class.path" />
    </java>
    <!-- Yes, yes.  Ugly, ugly hacks.  I know.  -->
    <move file="${dist}/run/grouper.script"      tofile="${dist}/run/grouper.script.last"/>
    <copy file="${dist}/run/grouper.script.orig" tofile="${dist}/run/grouper.script"/>
  </target>

  <target name="db" description="Launch HSQLDB UI">
    <mkdir dir="${dist}/run"/>
    <java classname="org.hsqldb.util.DatabaseManager" fork="yes">
      <classpath refid="project.class.path"/>
      <arg value="-driver"/>
      <arg value="${jdbc.driver}"/>
      <arg value="-url"/>
      <arg value="${jdbc.url}"/>
      <arg value="-user"/>
      <arg value="sa"/>
    </java>
  </target>

  <target name="db-init" 
    description="Initialize HSQDBL database">
    <mkdir dir="${dist}/run"/>
    <java classname="org.hsqldb.util.DatabaseManager" fork="yes">
      <classpath refid="project.class.path"/>
      <arg value="-driver"/>
      <arg value="${jdbc.driver}"/>
      <arg value="-url"/>
      <arg value="${jdbc.url}"/>
      <arg value="-user"/>
      <arg value="sa"/>
      <arg value="-script"/>
      <arg value="sql/hsqldb.sql"/>
    </java>
  </target>

  <target name="db-init-test" 
    description="Populate HSQLDB database with some test data">
    <mkdir dir="${dist}/run"/>
    <java classname="org.hsqldb.util.DatabaseManager" fork="yes">
      <classpath refid="project.class.path"/>
      <arg value="-driver"/>
      <arg value="${jdbc.driver}"/>
      <arg value="-url"/>
      <arg value="${jdbc.url}"/>
      <arg value="-user"/>
      <arg value="sa"/>
      <arg value="-script"/>
      <arg value="sql/base.sql"/>
    </java>
    <!-- I want a pristine copy to utilize later.  Yes, this is a kludge. -->
    <copy file="${dist}/run/grouper.script" tofile="${dist}/run/grouper.script.orig"/>
  </target>

</project>

