<!-- $Id: build.xml,v 1.44 2005-03-19 17:31:08 blair Exp $ -->

<project name="Grouper" default="build" basedir=".">

  <!-- set global properties for this build -->
  <property name="app.name"               value="Grouper"/>
  <property name="src"                    location="java"/>
  <property name="src.grouper"            location="${src}/src"/>
  <property name="src.test"               location="${src}/tests"/>
  <property name="build"                  location="build"/>
  <property name="build.grouper"          location="${build}/grouper"/>
  <property name="build.lib"              location="${build}/lib"/>
  <property name="build.test"             location="${build}/test"/>
  <property name="dist"                   location="dist"/>
  <property name="javadoc.source"         value="${src.grouper}"/>
  <property name="javadoc.dest.internal"  value="${dist}/api-int"/>
  <property name="javadoc.dest.public"    value="${dist}/api"/>
  <property name="javadoc.packages"       value="edu.internet2.middleware.grouper.*"/>
  <property name="jdbc.driver"            value="org.hsqldb.jdbcDriver"/>
  <property name="jdbc.url"               value="jdbc:hsqldb:${dist}/run/grouper"/>
  <property name="sql.type"               value="hsqldb"/>
  <property name="sql.create"             value="sql/schema-${sql.type}.sql"/>
  <property name="sql.test-data"          value="sql/test-data-${sql.type}.sql"/>

  <target name="init">
    <tstamp />
    <mkdir dir="${build.grouper}" />
    <mkdir dir="${build.test}" />
    <!-- only define our classpath once -->
    <path id="project.class.path">
      <pathelement path="${classpath}"/>
      <!-- for configuration files -->
      <pathelement path="${basedir}/conf"/>
      <fileset dir="java/lib">
        <include name="**/*.jar"/>
      </fileset>
      <pathelement location="${build.grouper}"/>
      <pathelement location="${build.test}"/>
    </path>
  </target>

  <target name="build" depends="init"
        description="compile the source " >
    <javac srcdir="${src.grouper}" destdir="${build.grouper}">
      <classpath refid="project.class.path"/>
    </javac>
  </target>

  <target name="dist" depends="build" description="generate the distribution" >
    <mkdir dir="${dist}/lib" />
    <jar jarfile="${dist}/lib/${app.name}-${DSTAMP}.jar" basedir="${build.grouper}" />
    <copy file="${dist}/lib/${app.name}-${DSTAMP}.jar"   tofile="${dist}/lib/${app.name}.jar" />
    <!-- This bothers me for some reason -->
    <unzip dest="${build.lib}">
      <fileset dir="java/lib">
        <include name="*.jar"/>
      </fileset>
    </unzip>
    <jar jarfile="${dist}/lib/${app.name}-lib-${DSTAMP}.jar" basedir="${build.lib}"/>
    <copy file="${dist}/lib/${app.name}-lib-${DSTAMP}.jar" tofile="${dist}/lib/${app.name}-lib.jar" />
  </target>

  <target name="jar" depends="dist" />

  <target name="clean" description="clean up" >
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
  </target>

  <target name="all" depends="dist,test,html" />

  <target name="html" depends="init" description="generate public api docs" >
    <!-- Let's be sure we clear out old cruft first... -->
    <delete dir="${javadoc.dest.public}" />
    <javadoc sourcepath="${javadoc.source}" 
      destdir="${javadoc.dest.public}" 
      packagenames="${javadoc.packages}" 
      excludepackagenames="edu.internet2.middleware.grouper.backend.*"
      classpathref="project.class.path" 
      access="public"
      author="true"/>
  </target>

  <target name="html-internal" depends="init" description="generate internal api docs" >
    <!-- Let's be sure we clear out old cruft first... -->
    <delete dir="${javadoc.dest.internal}" />
    <javadoc sourcepath="${javadoc.source}" 
      destdir="${javadoc.dest.internal}" 
      packagenames="${javadoc.packages}" 
      classpathref="project.class.path" 
      access="protected"
      author="true"/>
  </target>

  <target name="test" depends="test-run">
  </target>

  <target name="test-build" depends="build">
    <javac srcdir="${src.test}" destdir="${build.test}">
      <classpath refid="project.class.path" />
      <include name="**/*.java" />
    </javac>
  </target>

  <!-- 
    TODO Now that tests are stateless I shouldn't need to manually
         specific everything, right?  Actually no.  I need to wait
         until I have all of the test classes updated before I make
         that switch.
    -->
  <target name="test-run" depends="test-build,db-init-test">
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestInstantiate" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestConfigAndSchema" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestSubjects" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestSessions" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestMembers" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestStemsAdd" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestStemsDelete" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestStemsAttrs" />
      <classpath refid="project.class.path" />
    </java>
<!-- TODO TestStemsAttrsAdd -->
<!-- TODO TestStemsAttrsMod -->
<!-- TODO TestStemsAttrsDel -->
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestStemsMoF" />
      <classpath refid="project.class.path" />
    </java>
<!-- TODO TestStemsMoFAdd -->
<!-- TODO TestStemsMoFDel -->
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestGroupsAdd" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestGroupsDelete" />
      <classpath refid="project.class.path" />
    </java>
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestGroupsAttrs" />
      <classpath refid="project.class.path" />
    </java>
<!-- TODO TestGroupsAttrsAdd -->
<!-- TODO TestGroupsAttrsMod -->
<!-- TODO TestGroupsAttrsDel -->
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestGroupsMoF" />
      <classpath refid="project.class.path" />
    </java>
<!-- TODO TestGroupsMoFAdd -->
<!-- TODO TestGroupsMoFDel -->
<!-- TODO TestMixedMoF -->
<!-- TODO TestMixedMoFAdd -->
<!-- TODO TestMixedMoFDel -->
<!--
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestGroupLists" />
      <classpath refid="project.class.path" />
    </java>
-->
<!-- TODO TestNamingPrivs -->
<!-- TODO TestNamingPrivsGrant -->
<!-- TODO TestNamingPrivsRevoke -->
<!--
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestNamingPrivs" />
      <classpath refid="project.class.path" />
    </java>
-->
<!-- TODO TestAccessPrivs -->
<!-- TODO TestAccessPrivsGrant -->
<!-- TODO TestAccessPrivsRevoke -->
<!--
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestAccessPrivs" />
      <classpath refid="project.class.path" />
    </java>
-->
<!--
    <java fork="yes" classname="junit.textui.TestRunner" 
      taskname="junit" failonerror="true">
      <arg value="test.edu.internet2.middleware.grouper.TestQueries" />
      <classpath refid="project.class.path" />
    </java>
-->
  </target>

  <target name="db" depends="init" description="Launch HSQLDB UI">
    <mkdir dir="${dist}/run"/>
    <java classname="org.hsqldb.util.DatabaseManager" fork="yes">
      <classpath refid="project.class.path"/>
      <arg value="-driver"/>
      <arg value="${jdbc.driver}"/>
      <arg value="-url"/>
      <arg value="${jdbc.url}"/>
      <arg value="-user"/>
      <arg value="sa"/>
    </java>
  </target>

  <target name="db-init" depends="init" description="Initialize database">
    <property file="conf/hibernate.properties"/>
    <sql
      classpathref="project.class.path"
      driver="${hibernate.connection.driver_class}"
      url="${hibernate.connection.url}"
      userid="${hibernate.connection.username}"
      password="${hibernate.connection.password}"
      src="${sql.create}"
    />
    <sql
      classpathref="project.class.path"
      driver="${hibernate.connection.driver_class}"
      url="${hibernate.connection.url}"
      userid="${hibernate.connection.username}"
      password="${hibernate.connection.password}"
      src="sql/init.sql"
    />
  </target>

  <target name="db-init-test" depends="db-init" 
    description="Inserts test data into database">
    <property file="conf/hibernate.properties"/>
    <sql
      classpathref="project.class.path"
      driver="${hibernate.connection.driver_class}"
      url="${hibernate.connection.url}"
      userid="${hibernate.connection.username}"
      password="${hibernate.connection.password}"
      src="${sql.test-data}"
    />
  </target>

</project>

