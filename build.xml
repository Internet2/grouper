<!-- $Id: build.xml,v 1.91 2006-03-10 19:56:02 blair Exp $ -->

<project name="Grouper" default="build" basedir=".">

  <!-- Global Properties -->
  <property name="app.name"               value="grouper"/>
  <property name="impl.url" 
    value="http://middleware.internet2.edu/dir/groups/grouper/"/>
  <property name="impl.vendor"            value="Internet2"/>
  <property name="impl.version"           value="0.9"/>

  <property name="conf"                   location="${basedir}/conf"/>
  <property name="sql"                    location="${basedir}/sql"/>

  <property name="src"                    location="${basedir}/src"/>
  <property name="src.conf"               location="${src}/conf"/>
  <property name="src.grouper"            location="${src}/grouper"/>
  <property name="src.test"               location="${src}/tests"/>

  <property name="build"                  location="${basedir}/build"/>
  <property name="dist"                   location="${basedir}/dist"/>
  <property name="build.grouper"          location="${build}/grouper"/>
  <property name="build.javadoc"          location="${dist}/api"/>
  <property name="build.lib"              location="${build}/lib"/>
  <property name="build.test"             location="${build}/test"/>

  <property name="lib"                    location="${basedir}/lib"/>

  <property name="log.schema"             location="${basedir}/schemaexport.log"/>
  <property name="log.dbinit"             location="${basedir}/db-init.log"/>
  <property name="log.build"              location="${basedir}/build.log"/>
  <property name="log.test.build"         location="${basedir}/test-build.log"/>
  <property name="log.test.run"           location="${basedir}/test.log"/>

  <property name="hprof.depth"            value="20"/>
  <property name="max.memory"             value="128m"/>
  <!-- Global Properties -->

  <!-- build -->
  <target name="build" 
          depends="init, conf-init"
          description="compile the source " >
    <record name="${log.build}" action="start"/>
    <javac srcdir="${src.grouper}" destdir="${build.grouper}">
      <classpath refid="project.classpath"/>
    </javac>
    <record name="${log.build}" action="stop"/>
    <!-- include hibernate mappings -->
    <copy todir="${build.grouper}">
      <fileset dir="${src.grouper}" includes="**/*.hbm.xml"/>
    </copy>
  </target>
  <!-- build -->

  <!-- clean -->
  <target name="clean" description="clean up" >
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
    <delete dir="clover"/>
    <delete>
      <fileset dir="." includes="clover.db*"/>
    </delete>
  </target>
  <!-- clean -->

  <!-- conf-init -->
  <target name="conf-init"
          description="applies filter to several configuration files to set full paths"
          depends="init"
  >
    <dirname  property="base" 
              file="build.xml"
    />
    <pathconvert  targetos="unix"
                  property="converted.base"
    >
        <path path="${base}"/>
    </pathconvert>
    <filter token="base"  value="${converted.base}"/>
    <filter token="slash" value="${file.separator}"/>
    <copy todir="${conf}" filtering="true">
      <fileset dir="${src.conf}"/>
    </copy>
  </target>
  <!-- conf-init -->

  <!-- daemon-list -->
  <target name="daemon-list"
          depends="build"
          description="list GrouperDaemon transaction queue"
  >
    <java classname="edu.internet2.middleware.grouper.GrouperDaemon"
          fork="true"
    >
      <classpath refid="project.classpath"/>
      <arg value="list"/>
    </java>
  </target>
  <!-- daemon-list -->

  <!-- daemon-list-active -->
  <target name="daemon-list-active"
          depends="build"
          description="list active items in GrouperDaemon transaction queue"
  >
    <java classname="edu.internet2.middleware.grouper.GrouperDaemon"
          fork="true"
    >
      <classpath refid="project.classpath"/>
      <arg value="list-active"/>
    </java>
  </target>
  <!-- daemon-list-active -->

  <!-- daemon-list-failed -->
  <target name="daemon-list-failed"
          depends="build"
          description="list failed items in GrouperDaemon transaction queue"
  >
    <java classname="edu.internet2.middleware.grouper.GrouperDaemon"
          fork="true"
    >
      <classpath refid="project.classpath"/>
      <arg value="list-failed"/>
    </java>
  </target>
  <!-- daemon-list-failed -->

  <!-- daemon-start -->
  <target name="daemon-start"
          depends="build"
          description="run GrouperDaemon process"
  >
    <java classname="edu.internet2.middleware.grouper.GrouperDaemon"
          fork="true"
          spawn="false"
          maxmemory="${max.memory}"
    >
      <classpath refid="project.classpath"/>
      <arg value="start"/>
    </java>
  </target>
  <!-- daemon-start -->

  <!-- daemon-start-fork -->
  <target name="daemon-start-fork"
          description="start and fork GrouperDaemon process"
  >
    <java classname="edu.internet2.middleware.grouper.GrouperDaemon"
          fork="true"
          spawn="true"
          maxmemory="${max.memory}"
    >
      <classpath refid="project.classpath"/>
      <arg value="start"/>
    </java>
  </target>
  <!-- daemon-start-fork -->

  <!-- daemon-stop -->
  <target name="daemon-stop"
          description="stop GrouperDaemon process"
  >
    <java classname="edu.internet2.middleware.grouper.GrouperDaemon"
          fork="true"
    >
      <classpath refid="project.classpath"/>
      <arg value="stop"/>
    </java>
  </target>
  <!-- daemon-stop -->

  <!-- db -->
  <target name="db" depends="init" description="Launch HSQLDB UI">
    <property file="${conf}/hibernate.properties"/>
    <java fork="true"
          classname="org.hsqldb.util.DatabaseManager"
          maxmemory="${max.memory}"
    >
      <classpath refid="project.classpath"/>
      <arg value="-driver"/>
      <arg value="${hibernate.connection.driver_class}"/>
      <arg value="-url"/>
      <arg value="${hibernate.connection.url}"/>
      <arg value="-user"/>
      <arg value="${hibernate.connection.username}"/>
      <arg value="-password"/>
      <arg value="${hibernate.connection.password}"/>
    </java>
  </target>
  <!-- db -->

  <!-- db-init -->
  <target name="db-init" 
          depends="build"
          description="initialize database"
  >
    <record name="${log.dbinit}" action="start"/>
    <java classname="edu.internet2.middleware.grouper.RegistryInstall"
          fork="true"
    >
      <classpath refid="project.classpath"/>
    </java>
    <record name="${log.dbinit}" action="stop"/>
  </target>
  <!-- db-init -->

  <!-- db-reset -->
  <target name="db-reset"
          description="reset the db"
          depends="build"
  >
    <java fork="true"
          maxmemory="${max.memory}"
          classname="edu.internet2.middleware.grouper.RegistryReset"
    >
      <classpath refid="project.classpath"/>
    </java>
  </target>
  <!-- db-reset -->

  <!-- dist -->
  <target name="dist" 
          depends="build" 
          description="package grouper"
  >
    <mkdir dir="${dist}/lib" />
    <jar destfile="${dist}/lib/${app.name}-${DSTAMP}.jar" basedir="${build.grouper}">
      <manifest>
        <attribute name="Built-By"                value="${user.name}"/>
        <attribute name="Implementation-Vendor"   value="${impl.vendor}" />
        <attribute name="Implementation-Title"    value="${app.name}" />
        <attribute name="Implementation-Version"  value="${impl.version}" />
        <attribute name="Implementation-URL"      value="${impl.url}" />
      </manifest>
    </jar>
    <copy file="${dist}/lib/${app.name}-${DSTAMP}.jar"   
          tofile="${dist}/lib/${app.name}.jar" 
    />
  </target>
  <!-- dist -->

  <!-- dist-lib -->
  <target name="dist-lib"
          depends="init" 
          description="package 3rd party libraries"
    >
    <!-- ugly, i know -->
    <unzip dest="${build.lib}">
      <fileset dir="${lib}">
        <include name="*.jar"/>
        <exclude name="**/junit.jar"/>
      </fileset>
    </unzip>
    <!-- be sure to include _java/lib/README_ -->
    <copy file="${lib}/README" 
          tofile="${build.lib}/README"
    />
    <jar  jarfile="${dist}/lib/${app.name}-lib-${DSTAMP}.jar" 
          basedir="${build.lib}"
    />
    <copy file="${dist}/lib/${app.name}-lib-${DSTAMP}.jar" 
          tofile="${dist}/lib/${app.name}-lib.jar" 
    />
  </target>
  <!-- dist-lib -->

  <!-- ensure-stress-name -->
  <target name="ensure-stress-name" unless="name">
    <fail message="You must run this target with -Dname=StressName"/>
  </target>
  <!-- ensure-stress-name -->

  <!-- ensure-test-name -->
  <target name="ensure-test-name" unless="test">
    <fail message="You must run this target with -Dtest=TestName"/>
  </target>
  <!-- ensure-test-name -->

  <!-- html -->
  <target name="html" depends="build" description="generate public api docs" >
    <delete dir="${build.javadoc}"/>
    <mkdir  dir="${build.javadoc}"/>
    <javadoc  destdir="${build.javadoc}"
              author="true"
              version="true"
              access="public"
              stylesheetfile="${basedir}/doc/stylesheet.css"
              classpathref="project.classpath" 
    >
    <packageset dir="${src.grouper}" defaultexcludes="yes">
      <exclude name="edu/internet2/middleware/grouper/stress/**"/>
    </packageset>
    </javadoc>
  </target>
  <!-- html -->

  <!-- init -->
  <target name="init">
    <tstamp />
    <mkdir dir="${build.grouper}" />
    <mkdir dir="${build.test}" />
    <mkdir dir="${dist}" />
    <mkdir dir="${dist}/run" />
    <!-- only define our classpath once -->
    <path id="project.classpath">
      <pathelement path="${classpath}"/>
      <!-- for configuration files -->
      <pathelement location="${conf}"/>
      <fileset dir="${lib}">
        <include name="**/*.jar"/>
      </fileset>
      <pathelement  location="${build.grouper}"/>
      <pathelement  location="${build.test}"/>
      <pathelement  location="${user.home}/.ant/lib/clover.jar"/>
    </path>
  </target>
  <!-- init -->

  <!-- runtest -->
  <target name="runtest" 
          description="Runs the test you specify on the command line with -Dtest=" 
          depends="test-build, ensure-test-name">
    <record name="${log.test.run}" action="start"/>
    <antcall  target="daemon-start-fork"/>
    <junit printsummary="withOutAndErr" fork="true"> 
        <classpath    refid="project.classpath" />
        <formatter    type="plain" usefile="false"/>
      <batchtest>
        <fileset dir="${src.test}">
          <include name="**/${test}.java"/>
        </fileset>
      </batchtest>
    </junit>
    <antcall  target="daemon-stop"/>
    <record name="${log.test.run}" action="stop"/>
  </target>
  <!-- runtest -->

  <!-- runtestprof -->
  <target name="runtestprof" 
          description="Runs and profiles the test case you specify on the command line with -Dtest=" 
          depends="test-build, ensure-test-name">
    <record name="${log.test.run}" action="start"/>
    <antcall  target="daemon-start-fork"/>
    <java fork="true"
          maxmemory="${max.memory}"
          classname="junit.textui.TestRunner"
          taskname="junit"
          failonerror="true"
    >
      <arg    value="test.edu.internet2.middleware.grouper.${test}"/>
      <jvmarg value="-Xrunhprof:cpu=samples,file=hprof.txt,depth=${hprof.depth}"/>
      <classpath refid="project.classpath"/>
    </java>
    <antcall  target="daemon-stop"/>
    <record name="${log.test.run}" action="stop"/>
  </target>
  <!-- runtestprof -->

  <!-- schemaexport -->
  <target name="schemaexport" depends="build">
    <record name="${log.schema}" action="start"/>
    <mkdir dir="${dist}" />
    <mkdir dir="${dist}/run" />
    <taskdef name="schemaexport"
      classname="net.sf.hibernate.tool.hbm2ddl.SchemaExportTask"
      classpathref="project.classpath"
    />
    <schemaexport
      properties="${conf}/hibernate.properties"
      quiet="yes"
      text="no"
      drop="no"
      delimiter=";"
      output="${sql}/schema-export.sql">
      <fileset dir="${src.grouper}">
        <include name="**/*.hbm.xml"/>
      </fileset>
    </schemaexport>
    <record name="${log.schema}" action="stop"/>
  </target>
  <!-- schemaexport -->

  <!-- setup -->
  <target name="setup" 
          depends="build"
          description="initialize rdbms"
  >
    <antcall  target="daemon-start-fork"/>
    <antcall  target="schemaexport"/>
    <antcall  target="db-init"/>
    <antcall  target="daemon-stop"/>
  </target>
  <!-- setup -->

  <!-- stress -->
  <target name="stress" 
          description="Runs the stress case specified on the command line with -Dname="
          depends="build, ensure-stress-name">
    <java fork="true"
          maxmemory="${max.memory}"
          classname="edu.internet2.middleware.grouper.stress.${name}"
          failonerror="true"
    >
      <classpath refid="project.classpath"/>
    </java>
  </target>
  <!-- stress -->

  <!-- stressclean -->
  <target name="stressclean" 
          description="clean up stress output" >
    <delete>
      <fileset dir="." includes="stress-*-*.txt"/>
    </delete>
  </target>
  <!-- stressclean -->

  <!-- stressprof -->
  <target name="stressprof" 
          description="Runs and profiles the stress case specified on the command line with -Dname="
          depends="build, ensure-stress-name">
    <java fork="true"
          maxmemory="${max.memory}"
          classname="edu.internet2.middleware.grouper.stress.${name}"
          failonerror="true"
    >
      <jvmarg value="-Xrunhprof:cpu=samples,file=stress-${name}-${DSTAMP}${TSTAMP}.txt,depth=${hprof.depth}"/>
      <classpath refid="project.classpath"/>
    </java>
  </target>
  <!-- stressprof -->

  <!-- test-build -->
  <target name="test-build" depends="build">
    <record name="${log.test.build}" action="start"/>
    <javac srcdir="${src.test}" destdir="${build.test}">
      <classpath  refid="project.classpath"/>
      <include name="**/*.java" />
    </javac>
    <record name="${log.test.build}" action="stop"/>
  </target>
  <!-- test-build -->

  <!-- test -->
  <target name="test" depends="test-build">
    <echo/>
    <echo message="A single 'FATAL GrouperSession: unable to get subject
associated with session' message is expected and does not indicate an
error"
    />
    <echo/>
    <record name="${log.test.run}" action="start"/>
    <!-- Run the test suite -->
    <antcall  target="daemon-start-fork"/>
    <java fork="true" 
          maxmemory="${max.memory}"
          classname="junit.textui.TestRunner"
          taskname="junit" 
          failonerror="true"
    >
      <arg value="test.edu.internet2.middleware.grouper.SuiteAll"/>
      <classpath refid="project.classpath"/>
    </java>
    <antcall  target="daemon-stop"/>
    <record name="${log.test.run}" action="stop"/>
  </target>
  <!-- test -->

  <target name="jar" depends="dist" />

  <target name="with.clover" depends="init">
    <taskdef resource="clovertasks"/>
    <clover-setup initString="clover.db">
      <fileset dir="${src.grouper}">
        <exclude name="**/stress/*"/>
        <exclude name="**/*Factor*.java"/>
        <exclude name="**/*Status*.java"/>
      </fileset>
    </clover-setup>
  </target> 

  <target name="clover.html" depends="with.clover">
    <clover-report>
      <current outfile="clover">
        <format type="html"/>
      </current>
    </clover-report>
  </target>

  <target name="clover.log" depends="with.clover">
    <clover-log/>
  </target>

 <target name="clover.swing" depends="with.clover">
   <clover-view/>
 </target>

<!-- deprecated -->

  <!-- codegen -->
<!--
  <target name="codegen" depends="init">
    <mkdir dir="${dist}" />
    <mkdir dir="${dist}/run" />
    <taskdef name="hbm2java"
      classname="net.sf.hibernate.tool.hbm2java.Hbm2JavaTask"
      classpathref="project.classpath"
    />
    <hbm2java config="${conf}/codegen.cfg.xml" output="${src.grouper}">
      <fileset dir="${src.grouper}">
        <include name="**/*.hbm.xml"/>
      </fileset>
    </hbm2java>
  </target>
-->
  <!-- codegen -->

</project>

